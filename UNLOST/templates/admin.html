{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1 class="page-title">Admin Dashboard</h1>

    <style>
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
            gap: 1rem;
        }

        .nav-link {
            padding: 0.75rem 1.5rem;
            border: none;
            background: none;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }

        .nav-link:hover {
            color: var(--color-primary);
        }

        .nav-link.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>

    <div class="nav-tabs">
        <button class="nav-link active" onclick="openTab('overview', this)">Overview</button>
        <button class="nav-link" onclick="openTab('history', this)">History Log</button>
        <button class="nav-link" onclick="openTab('security', this)">
            <i class="fa-solid fa-shield-halved"></i> Security Alerts
        </button>
    </div>

    <!-- Tab 1: Overview -->
    <div id="overview" class="tab-pane active">
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 3rem;">
            <div class="card">
                <div class="card-body" style="text-align: center;">
                    <h3 style="color: var(--text-muted); margin-bottom: 0.5rem;">Total Items</h3>
                    <p style="font-size: 3rem; font-weight: 700; color: var(--color-primary); margin: 0;">{{ total_items
                        }}</p>
                </div>
            </div>
            <div class="card">
                <div class="card-body" style="text-align: center;">
                    <h3 style="color: var(--text-muted); margin-bottom: 0.5rem;">Total Users</h3>
                    <p style="font-size: 3rem; font-weight: 700; color: var(--color-secondary); margin: 0;">{{
                        total_users }}</p>
                </div>
            </div>
        </div>

        <h2 style="margin-bottom: 1.5rem;">Recent Items</h2>
        <div class="card">
            <div class="card-body">
                {% if recent_items %}
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 1rem;">Image</th>
                            <th style="text-align: left; padding: 1rem;">Title</th>
                            <th style="text-align: left; padding: 1rem;">Category</th>
                            <th style="text-align: left; padding: 1rem;">Status</th>
                            <th style="text-align: left; padding: 1rem;">Date</th>
                            <th style="text-align: left; padding: 1rem;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in recent_items %}
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 1rem;">
                                {% if item.image_file %}
                                <img src="{{ url_for('static', filename='uploads/' + item.image_file) }}"
                                    alt="Item Image"
                                    style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                                {% else %}
                                <span style="color: var(--text-muted);">No Image</span>
                                {% endif %}
                            </td>
                            <td style="padding: 1rem;">{{ item.title }}</td>
                            <td style="padding: 1rem;">{{ item.category }}</td>
                            <td style="padding: 1rem;">
                                <span class="badge {{ 'found' if item.status == 'Found' else 'lost' }}">
                                    {{ item.status }}
                                </span>
                            </td>
                            <td style="padding: 1rem;">{{ item.date.strftime('%Y-%m-%d') if item.date else 'N/A' }}</td>
                            <td style="padding: 1rem;">
                                <form action="{{ url_for('delete_item', item_id=item._id) }}" method="POST"
                                    onsubmit="return confirm('Are you sure you want to remove this item?');"
                                    style="display:inline;">
                                    <button type="submit"
                                        style="background-color: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                        Remove
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: var(--text-muted); text-align: center;">No items found.</p>
                {% endif %}
            </div>
        </div>
    </div>


    <div id="history" class="tab-pane">
        <h2 style="margin-bottom: 1.5rem;">Trash / Recoverable Items</h2>
        <div class="card" style="margin-bottom: 3rem;">
            <div class="card-body">
                {% if trash_items %}
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 1rem;">Item</th>
                            <th style="text-align: left; padding: 1rem;">Deleted At</th>
                            <th style="text-align: left; padding: 1rem;">Original Status</th>
                            <th style="text-align: left; padding: 1rem;">Time Left</th>
                            <th style="text-align: left; padding: 1rem;">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in trash_items %}
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 1rem;">{{ item.title }}</td>
                            <td style="padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                {{ item.deleted_at.strftime('%Y-%m-%d %H:%M') if item.deleted_at else 'Unknown' }}
                            </td>
                            <td style="padding: 1rem;">
                                <span class="badge {{ 'found' if item.previous_status == 'Found' else 'lost' }}">
                                    {{ item.previous_status }}
                                </span>
                            </td>
                            <td style="padding: 1rem; font-weight: 500;">
                                {% if item.deleted_at %}
                                {% set days_passed = (now - item.deleted_at.replace(tzinfo=now.tzinfo)).days %}
                                {% set days_left = 10 - days_passed %}

                                {% if days_left < 0 %} <span style="color: #ef4444;">Expired</span>
                                    {% else %}
                                    <span style="color: #10b981;">{{ days_left }} days left</span>
                                    {% endif %}
                                    {% else %}
                                    <span style="color: var(--text-muted);">N/A</span>
                                    {% endif %}
                            </td>
                            <td style="padding: 1rem;">
                                {% if item.deleted_at and (now - item.deleted_at.replace(tzinfo=now.tzinfo)).days <= 10
                                    %} <form action="{{ url_for('recover_item', item_id=item._id) }}" method="POST"
                                    style="display:inline;">
                                    <button type="submit" class="btn-primary"
                                        style="padding: 0.4rem 1rem; font-size: 0.9rem; background-color: #10b981; box-shadow: none;">
                                        Recover
                                    </button>
                                    </form>
                                    {% else %}
                                    <button disabled
                                        style="padding: 0.4rem 1rem; font-size: 0.9rem; background-color: var(--card-border); color: var(--text-muted); border: none; border-radius: var(--radius-full);">
                                        Unrecoverable
                                    </button>
                                    {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: var(--text-muted); text-align: center;">Trash is empty.</p>
                {% endif %}
            </div>
        </div>

        <h2 style="margin-bottom: 1.5rem;">Audit Log</h2>
        <div class="card">
            <div class="card-body">
                {% if logs %}
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 1rem;">Timestamp</th>
                            <th style="text-align: left; padding: 1rem;">Action</th>
                            <th style="text-align: left; padding: 1rem;">Item</th>
                            <th style="text-align: left; padding: 1rem;">User/Admin</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs if 'Security Alert' not in log.action %}
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                {{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}
                            </td>
                            <td style="padding: 1rem;">
                                <span class="badge {{ 'reported' if 'Reported' in log.action else 'alert' }}">
                                    {{ log.action }}
                                </span>
                            </td>
                            <td style="padding: 1rem;">{{ log.item_title }}</td>
                            <td style="padding: 1rem; font-size: 0.9rem;">{{ log.user or log.admin }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p style="color: var(--text-muted); text-align: center;">No history available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tab 3: Security -->
    <div id="security" class="tab-pane">
        <h2 style="margin-bottom: 1.5rem;">Security Alerts (Potential Fraud)</h2>
        <div class="card">
            <div class="card-body">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 1rem;">Timestamp</th>
                            <th style="text-align: left; padding: 1rem;">Alert Type</th>
                            <th style="text-align: left; padding: 1rem;">Item Targeted</th>
                            <th style="text-align: left; padding: 1rem;">Input Tried</th>
                            <th style="text-align: left; padding: 1rem;">User IP/ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set ns = namespace(found=false) %}
                        {% for log in logs if 'Security Alert' in log.action %}
                        {% set ns.found = true %}
                        <tr style="border-bottom: 1px solid var(--border-color);" class="row-alert">
                            <td style="padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                {{ log.timestamp.strftime('%Y-%m-%d %H:%M') }}
                            </td>
                            <td style="padding: 1rem;" class="text-danger">
                                <i class="fa-solid fa-triangle-exclamation"></i> {{ log.action }}
                            </td>
                            <td style="padding: 1rem;">{{ log.item_title }}</td>
                            <td style="padding: 1rem; font-family: monospace;">{{ log.input_provided }}</td>
                            <td style="padding: 1rem; font-size: 0.9rem;">{{ log.user }}</td>
                        </tr>
                        {% endfor %}

                        {% if not ns.found %}
                        <tr>
                            <td colspan="5" style="padding: 2rem; text-align: center; color: var(--text-muted);">
                                No security alerts detected (yet).
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function openTab(tabName, btnElement) {
        // Hide all elements with class="tab-pane"
        const tabPanes = document.getElementsByClassName("tab-pane");
        for (let i = 0; i < tabPanes.length; i++) {
            tabPanes[i].classList.remove("active");
        }

        // Remove active class from all buttons
        const navLinks = document.getElementsByClassName("nav-link");
        for (let i = 0; i < navLinks.length; i++) {
            navLinks[i].classList.remove("active");
        }

        // Show the specific tab content
        document.getElementById(tabName).classList.add("active");

        // Add active class to the button that opened the tab
        btnElement.classList.add("active");
    }
</script>
</div>
{% endblock %}